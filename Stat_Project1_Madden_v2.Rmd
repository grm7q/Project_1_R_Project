---
title: 'STAT 6021: Project 1'
author: "Greg Madden, Maxwell Levinson, Andrew Setaro, and Trey Hamilton"
date: "3/3/2022"
output: pdf_document
---

```{r echo = FALSE}
library(MASS)
library(tidyverse)
library(readr)
options(scipen = 999)
```

Reading in dataframe

```{r error = FALSE}

Data <- read_csv("diamonds4.csv")

```

Refactoring categorical variables
```{r}
#colnames(Data)
Data <- Data %>%
  #note VVS1 diamonds rank higher on the clarity scale than VVS2
  mutate(clarity = clarity%>%fct_relevel(c("FL", "IF", "VVS1","VVS2","VS1","VS2", "SI1", "SI2"))) %>%
  mutate(color = color%>%fct_relevel(c("D", "E", "F","G","H","I", "J"))) %>%
  mutate(cut = cut%>%fct_relevel(c("Good", "Very Good", "Ideal","Astor Ideal")))

# reordering so that price is first
Data <- Data[, c(5, 1, 2, 3, 4)]
```
Tasks: You have been approached by Blue Nile to perform the following tasks:

1. Use data visualizations to explore how price is related to the other variables (carat, clarity, color, cut), as well as how the other variables may relate to each other. 

```{r error = FALSE}
pairs(Data, lower.panel = NULL)
```

```{r}
library(viridis)
Data %>%
  ggplot(aes(x=carat, y = price, color = color)) +
  geom_point(alpha = 0.4) +
  labs(x="Carats", y="Price ($)", title = "Blue Nile Diamonds: Factors Influencing Price") +
  guides(color = guide_legend(title = "Color"), label.position = "right") +
    scale_color_viridis(discrete = TRUE, option = "A") +
  scale_fill_viridis(discrete = TRUE) +
   facet_wrap(~ cut + clarity)
```




Address the various claims on the diamond education page on Blue Nile.

* Cut: https://www.bluenile.com/education/diamonds/cut
  +"A diamond’s cut refers to how well-proportioned the dimensions of a diamond are, and how these surfaces, or facets, are positioned to create sparkle and brilliance. For example, what is the ratio of the diamond’s diameter in comparison to its depth? These small, yet essential, factors determine the diamond’s beauty and price."

Assertion above is that better cuts correlate with higher price. Let's check the scatterplot to see if that bears out in the data: 


Increasing quality of diamond cut does not seem to have a linear relationship with price, contrary to the Blue Nile's claim. 
```{r}
Data %>%
  ggplot(aes(x=cut, y=price)) +
  geom_point() +
  geom_smooth(method="lm",se=F) +
  labs(x="Cut", y="Price ($)", title = "Blue Nile Diamonds: Cut and Price") 
```




2. Fit an appropriate simple linear regression for price against carat.


First a scatterplot
```{r}
Data %>%
  ggplot(aes(x=carat, y=price)) +
  geom_point() +
  geom_smooth(method="lm",se=F) +
  labs(x="Carats", y="Price ($)", title = "Blue Nile Diamonds: Factors Influencing Price") 
```
Fitting the model
```{r error = FALSE}
result<-lm(price~ carat, data=Data)
summary(result)
```
Plotting the residuals. 

Constant variance and mean of error = 0 assumptions do not appear to be met. 

```{r}
yhat<-result$fitted.values
res<-result$residuals
Data<-data.frame(Data,yhat,res)


ggplot(Data, aes(x=yhat,y=res))+
  geom_point()+
  geom_hline(yintercept=0, color="red")+
  labs(x="Fitted y", y="Residuals", title="Residual Plot")
```

Variance is definitely not contant so attempting to transform y first. Will start with boxcox plot to see what the optimal lambda may be. 

Looks like a lambda of 0.31 would be appropriate. 

```{r error = FALSE}
boxcox(result, lambda = seq(.25,0.35,1/100))
```


Transforming the y and plotting a new variables

```{r error = FALSE}
ystar <- (Data$price)^(0.31)
Data<-data.frame(Data,ystar)

Data %>%
  ggplot(aes(x=carat, y=ystar)) +
  geom_point() +
  geom_smooth(method="lm",se=F) +
  labs(x="Carats", y="Price ($)*", title = "Blue Nile Diamonds: Factors Influencing Price") 

```



New residual plot: 

```{r error = FALSE}
result.ystar<- lm(ystar~carat, data=Data)

#storing fitted y residuals
yhat2 <- result.ystar$fitted.values
res2 <- result.ystar$residuals
#add to data frame

Data <-data.frame(Data,yhat2,res2)

#residual plot
Data %>%
  ggplot(aes(x=yhat2,y=res2)) +
  geom_point() +
  geom_hline(yintercept=0,color="red")+
  labs(x="fitted y*", y = "residuals", title="residual plot")
```

variance looks better but mean of errors still not equal to zero over x so will attempt to transform the x variable. Given the curved appearance, will try a square root transformation.
Confirming that the box cox plot looks better. Now I see that confidence interval includes 1. so next step will be to consider transforming x. 

```{r error = FALSE}

boxcox(result.ystar)
#boxcox(result.ystar, lambda = seq(-1,5.5,1/10))

```

```{r error = FALSE}
xstar <- sqrt(Data$carat)
Data<-data.frame(Data,xstar)

Data %>%
  ggplot(aes(x=xstar, y=ystar)) +
  geom_point() +
  geom_smooth(method="lm",se=F) +
  labs(x="Carats*", y="Price ($)*", title = "Blue Nile Diamonds: Factors Influencing Price (SLR Model)") 
```


Fitting new model and creating yet another residual plot: 


```{r}
result.ystar.xstar<- lm(ystar~xstar, data=Data)

#storing fitted y residuals
yhat3 <- result.ystar.xstar$fitted.values
res3 <- result.ystar.xstar$residuals
#add to data frame

Data <-data.frame(Data,yhat3,res3)

#residual plot
Data %>%
  ggplot(aes(x=yhat3,y=res3)) +
  geom_point() +
  geom_hline(yintercept=0,color="red")+
  labs(x="fitted y", y = "residuals", title="residual plot")
```

Not perfect but overall better. Summarizing the model. 

```{r}
summary(result.ystar.xstar)

```

ACF Plot

Assumption met.  

```{r}
acf(res3,main="ACF Plot of Residuals with xstar and ystar")

```

Normality assumption is not met but this may be the least important. 
```{r}
qqnorm(res3)
qqline(res3,col="red")
```
```{r error = FALSE}

```





```{r error = FALSE}

```


