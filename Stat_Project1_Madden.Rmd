---
title: 'STAT 6021: Project 1'
author: "Greg Madden, Maxwell Levinson, Andrew Setaro, and Trey Hamilton"
date: "3/3/2022"
output: pdf_document
---

```{r include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, tidy = TRUE)
#note 'include = FALSE' completely hides the chunk, 'echo = FALSE' means to not include the code. 'message = FALSE' means you will not see any messages after it runs, 'results = 'hide'' hides the output, and 'warning = FALSE' hides any warnings. 
```

```{r include = FALSE}


library(MASS)
library(tidyverse)
library(readr)
library(viridis)
options(scipen = 999)
```


```{r, include = FALSE}
#Reading in dataframe
Data <- read_csv("diamonds4.csv")

```


```{r, include = FALSE}
#tidying data
#Refactoring categorical variables
Data <- Data %>%
  #note VVS1 diamonds rank higher on the clarity scale than VVS2
  mutate(clarity = clarity%>%fct_relevel(c("FL", "IF", "VVS1","VVS2","VS1","VS2", "SI1", "SI2"))) %>%
  mutate(color = color%>%fct_relevel(c("D", "E", "F","G","H","I", "J"))) %>%
  mutate(cut = cut%>%fct_relevel(c("Good", "Very Good", "Ideal","Astor Ideal")))

# reordering so that price is first
Data <- Data[, c(5, 1, 2, 3, 4)]
```
###We have been approached by Blue Nile to perform the following tasks:

1. Use data visualizations to explore how price is related to the other variables (carat, clarity, color, cut), as well as how the other variables may relate to each other. 

```{r, echo = FALSE, error = FALSE}
pairs(Data, lower.panel = NULL)
```

Note that the x-axis above corresponds to increasing desireability of the factored categorical variables: clarity, color, and cut. In the above scatterplot matrix how price appears to have the clearest linear relationship with carats.  
```{r, echo = FALSE, error = FALSE, fig.width = 12, fig.height= 10}
#note: out.extra='angle=90' makes it landscape
#fig.height/width indicate percentage of image container that the plot will assume

Data %>%
  ggplot(aes(x=carat, y = price, color = color)) +
  geom_point(alpha = 0.4) +
  labs(x="Carats", y="Price ($)", title = "Blue Nile Diamond Characteristics Influencing Price by Carat Size") +
  guides(color = guide_legend(title = "Color"), label.position = "right") +
    scale_color_viridis(discrete = TRUE, option = "A") +
  scale_fill_viridis(discrete = TRUE) +
   facet_wrap(~ cut + clarity) 

```


In the above plot, you can see that certain cut/clarity combinations (e.g., Good cut and VVS2 clarity) have different slopes in terms of their price ~ carat relationships. For example, ideal cut with FL (Flawless) clarity appears to have a higher price per additional carat size than the Ideal Cut with SI2 (Slightly Included). In addition, more desireable colors (i.e.D-F) appear to cluster at the lower price ranges.



###Address the various claims on the diamond education page on Blue Nile.

* Cut: https://www.bluenile.com/education/diamonds/cut
  +"A diamond’s cut refers to how well-proportioned the dimensions of a diamond are, and how these surfaces, or facets, are positioned to create sparkle and brilliance. For example, what is the ratio of the diamond’s diameter in comparison to its depth? These small, yet essential, factors determine the diamond’s beauty and price."

Assertion above is that better cuts correlate with higher price. Let's check the scatterplot to see if that bears out in the data: 

```{r, tidy = TRUE, echo = FALSE, error = FALSE}
Data %>%
  ggplot(aes(x=cut, y=price)) +
  geom_point() +
  #geom_smooth(method="lm",se=F) +
  labs(x="Cut", y="Price ($)", title = "Blue Nile Diamonds: Cut and Price") 
```

As shown above, increasing quality of diamond cut does not seem to have a linear relationship with price, contrary to the Blue Nile's claim. 


##2. Fit an appropriate simple linear regression for price against carat.


First checking a scatterplot for Price ~ Carat: 


```{r, echo = FALSE, warning=FALSE, error = FALSE}
Data %>%
  ggplot(aes(x=carat, y=price)) +
  geom_point() +
  geom_smooth(method="lm",se=F) +
  labs(x="Carats", y="Price ($)", title = "Blue Nile Diamonds: Factors Influencing Price") 
```

Model Summary: 

```{r, echo = FALSE, messages = FALSE, error = FALSE}
#Fitting the model
result<-lm(price~ carat, data=Data)
summary(result)
```
Plotting the residuals. 

***Constant variance and mean of error = 0 assumptions do not appear to be met.***

```{r, echo = FALSE, error = FALSE}
yhat<-result$fitted.values
res<-result$residuals
Data<-data.frame(Data,yhat,res)


ggplot(Data, aes(x=yhat,y=res))+
  geom_point()+
  geom_hline(yintercept=0, color="red")+
  labs(x="Fitted y", y="Residuals", title="Residual Plot")
```

Variance is definitely not contant so attempting to transform y first. Will start with boxcox plot to see what the optimal lambda may be. 

***Looked like a lambda of 0.31 would be appropriate.***

```{r, echo = FALSE, error = FALSE}
boxcox(result, lambda = seq(.25,0.35,1/100))
```


Replotting the scatter plot with the transformed y variable. 

```{r, echo = FALSE, error = FALSE}
ystar <- (Data$price)^(0.31)
Data<-data.frame(Data,ystar)

Data %>%
  ggplot(aes(x=carat, y=ystar)) +
  geom_point() +
  geom_smooth(method="lm",se=F) +
  labs(x="Carats", y="Price ($)*", title = "Blue Nile Diamonds: Factors Influencing Price") 

```

New residual plot: 

***variance looks better but mean of errors still not equal to zero over x so will attempt to transform the x variable. Given the curved appearance, will try a square root transformation.***
```{r, echo = FALSE, error = FALSE}
result.ystar<- lm(ystar~carat, data=Data)

#storing fitted y residuals
yhat2 <- result.ystar$fitted.values
res2 <- result.ystar$residuals
#add to data frame

Data <-data.frame(Data,yhat2,res2)

#residual plot
Data %>%
  ggplot(aes(x=yhat2,y=res2)) +
  geom_point() +
  geom_hline(yintercept=0,color="red")+
  labs(x="fitted y*", y = "residuals", title="residual plot")
```


Confirming that the box cox plot looks better. Now I see that confidence interval includes 1. Next step is to consider whether or not to transform x. 

Boxcox plot: 

```{r, echo = FALSE, error = FALSE}

boxcox(result.ystar)
#boxcox(result.ystar, lambda = seq(-1,5.5,1/10))

```

Plotting the scatterplot using the transformed x (sqrt(x)) and y (y^0.31) variables. 

```{r, echo = FALSE, error = FALSE}
xstar <- sqrt(Data$carat)
Data<-data.frame(Data,xstar)

Data %>%
  ggplot(aes(x=xstar, y=ystar)) +
  geom_point() +
  geom_smooth(method="lm",se=F) +
  labs(x="Carats*", y="Price ($)*", title = "Blue Nile Diamonds: Factors Influencing Price (SLR Model)") 
```


Fitting new model and creating another residual plot. 

***Not a perfect fit but overall improved and adequate for prediction. ***


```{r, echo = FALSE, error = FALSE}
result.ystar.xstar<- lm(ystar~xstar, data=Data)

#storing fitted y residuals
yhat3 <- result.ystar.xstar$fitted.values
res3 <- result.ystar.xstar$residuals
#add to data frame

Data <-data.frame(Data,yhat3,res3)

#residual plot
Data %>%
  ggplot(aes(x=yhat3,y=res3)) +
  geom_point() +
  geom_hline(yintercept=0,color="red")+
  labs(x="fitted y", y = "residuals", title="residual plot")
```

Summarizing the final model below:

```{r, echo = FALSE, error = FALSE}
summary(result.ystar.xstar)

```

ACF Plot:

***Errors do not appear correlated to each other.  ***

```{r, echo = FALSE, error = FALSE}
acf(res3,main="ACF Plot of Residuals with xstar and ystar")

```

QQ Plot:
***Normality assumption is not met but this may be the least important.*** 

```{r, echo = FALSE, error = FALSE}
qqnorm(res3)
qqline(res3,col="red")
```




